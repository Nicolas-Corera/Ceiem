<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Presidente Junta Electoral - CEIEM 2025</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  </head>
  <body>
    <div id="authOverlay" class="auth-overlay">
      <div class="auth-modal">
        <div class="auth-logo"></div>
        <h2>Acceso Administrativo</h2>
        <p class="auth-subtitle">Ingrese el PIN de 6 dígitos para continuar</p>
        <div class="pin-container">
          <input
            type="password"
            class="pin-input"
            maxlength="1"
            data-index="0"
          />
          <input
            type="password"
            class="pin-input"
            maxlength="1"
            data-index="1"
          />
          <input
            type="password"
            class="pin-input"
            maxlength="1"
            data-index="2"
          />
          <input
            type="password"
            class="pin-input"
            maxlength="1"
            data-index="3"
          />
          <input
            type="password"
            class="pin-input"
            maxlength="1"
            data-index="4"
          />
          <input
            type="password"
            class="pin-input"
            maxlength="1"
            data-index="5"
          />
        </div>
        <button id="loginBtn" class="auth-btn">Verificar & Continuar</button>
        <div id="authError" class="auth-error" style="display: none"></div>
      </div>
    </div>
    <main class="containerPje">
      <div class="main-content-auth" id="mainContent">
        <div class="participation-stats">
          <h2 class="stats-title">Estadísticas de Participación</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Votantes</div>
              <div class="stat-number" id="totalAlumnos">0</div>
              <div class="stat-label">de 1478 estudiantes</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Votos Emitidos</div>
              <div class="stat-number" id="totalVotos">0</div>
              <div class="stat-label">de 1478 estudiantes</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Participación</div>
              <div class="stat-number" id="participacion">0%</div>
              <div class="stat-label" id="total-students-porcentaje">
                0/1478 estudiantes
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="contentPje">
        <h1>Descargar datos</h1>
        <button id="exportarExcel" class="btn btn-primary">
          Exportar a Excel
        </button>
      </div>
    </main>
    <script type="module" src="assets/js/export-excel.js"></script>
    <script type="module" src="assets/js/stats.js"></script>
    <script>
      const AUTH_PIN = "191969";
      const AUTH_KEY = "voting_pje_auth";
      class AuthSystem {
        constructor() {
          this.currentPin = "";
          this.init();
        }
        init() {
          if (this.isAuthenticated()) {
            this.showMainContent();
          } else {
            this.showAuthModal();
          }
          const pinInputs = document.querySelectorAll(".pin-input");
          pinInputs.forEach((input, index) => {
            input.addEventListener("input", (e) =>
              this.handlePinInput(e, index)
            );
            input.addEventListener("keydown", (e) =>
              this.handleKeydown(e, index)
            );
            input.addEventListener("paste", (e) => this.handlePaste(e));
          });
          document
            .getElementById("loginBtn")
            .addEventListener("click", () => this.login());

          window.addEventListener("beforeunload", () => {
            sessionStorage.removeItem(AUTH_KEY);
          });
        }
        handlePinInput(e, index) {
          const input = e.target;
          const value = input.value;

          if (value.length === 1 && /^\d$/.test(value)) {
            input.classList.add("filled");
            this.updatePin();
            if (index < 5) {
              const nextInput = document.querySelector(
                `[data-index="${index + 1}"]`
              );
              nextInput.focus();
            } else {
              setTimeout(() => this.login(), 100);
            }
          } else {
            input.value = "";
            input.classList.remove("filled");
            this.updatePin();
          }
        }
        handleKeydown(e, index) {
          const input = e.target;
          if (e.key === "Backspace" && input.value === "" && index > 0) {
            const prevInput = document.querySelector(
              `[data-index="${index - 1}"]`
            );
            prevInput.focus();
            prevInput.value = "";
            prevInput.classList.remove("filled");
            this.updatePin();
          } else if (e.key === "ArrowLeft" && index > 0) {
            const prevInput = document.querySelector(
              `[data-index="${index - 1}"]`
            );
            prevInput.focus();
          } else if (e.key === "ArrowRight" && index < 5) {
            const nextInput = document.querySelector(
              `[data-index="${index + 1}"]`
            );
            nextInput.focus();
          } else if (e.key === "Enter") {
            this.login();
          }
        }
        handlePaste(e) {
          e.preventDefault();
          const paste = e.clipboardData.getData("text");
          if (/^\d{6}$/.test(paste)) {
            const pinInputs = document.querySelectorAll(".pin-input");
            [...paste].forEach((digit, index) => {
              if (index < 6) {
                pinInputs[index].value = digit;
                pinInputs[index].classList.add("filled");
              }
            });
            this.updatePin();
            setTimeout(() => this.login(), 100);
          }
        }
        updatePin() {
          const pinInputs = document.querySelectorAll(".pin-input");
          this.currentPin = Array.from(pinInputs)
            .map((input) => input.value)
            .join("");
        }
        login() {
          const errorDiv = document.getElementById("authError");
          if (this.currentPin === AUTH_PIN) {
            sessionStorage.setItem(AUTH_KEY, "true");
            this.showMainContent();
            errorDiv.style.display = "none";
          } else {
            errorDiv.textContent = "PIN incorrecto. Inténtelo nuevamente.";
            errorDiv.style.display = "block";
            this.clearPin();
            const modal = document.querySelector(".auth-modal");
            modal.style.animation = "shake 0.5s";
            setTimeout(() => {
              modal.style.animation = "";
            }, 500);
          }
        }
        clearPin() {
          const pinInputs = document.querySelectorAll(".pin-input");
          pinInputs.forEach((input) => {
            input.value = "";
            input.classList.remove("filled");
          });
          this.currentPin = "";
          pinInputs[0].focus();
        }
        isAuthenticated() {
          return sessionStorage.getItem(AUTH_KEY) === "true";
        }
        showMainContent() {
          document.getElementById("authOverlay").style.display = "none";
          document.getElementById("mainContent").classList.add("authenticated");
        }
        showAuthModal() {
          document.getElementById("authOverlay").style.display = "flex";
          document
            .getElementById("mainContent")
            .classList.remove("authenticated");
          setTimeout(() => {
            document.querySelector(".pin-input").focus();
          }, 100);
        }
      }
      document.addEventListener("DOMContentLoaded", () => {
        new AuthSystem();
      });
    </script>
  </body>
</html>
